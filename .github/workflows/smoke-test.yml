name: smoke-test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    name: Smoke test (make smoke-test)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Make scripts executable
        run: |
          chmod +x bin/*.sh || true
          chmod +x bin/*.py || true

      - name: Sync player assets (from media-pack -> artifacts)
        run: make -f asciinema.mk sync-player

      - name: Debug artifacts (before smoke)
        run: |
          echo "ARTIFACTS LISTING:";
          ls -la artifacts || true;
          echo "index.html head:";
          head -n 60 artifacts/index.html || true;
          echo "asciinema-glue.js head:";
          head -n 60 artifacts/asciinema-glue.js || true;
          echo "asciinema-player.min.js size and head:";
          wc -c artifacts/asciinema-player.min.js || true;
          head -n 20 artifacts/asciinema-player.min.js || true;
          echo "smoke wrapper head:";
          head -n 120 artifacts/smoke.cast.html || true

      - name: Run smoke-test
        env:
          STRICT_INVARIANTS: 'true'
          CI: 'true'
        run: make -f hunchly.mk smoke-test

      - name: Upload artifacts directory
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: artifacts
